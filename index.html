<!doctype>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="http://cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css">
<script type="text/javascript" src="./node_modules/bignumber.js/bignumber.min.js"></script>
<script type="text/javascript" src="./dist/web3-light.js"></script>
<style type="text/css">

body {background-color: #ecf0f1}
</style>
<script type="text/javascript">

var Web3 = require('web3');
//var web3 = new Web3();

window.addEventListener('load', function() {

  // Checking if Web3 has been injected by the browser (Mist/MetaMask)
  if (typeof web3 !== 'undefined') {
    // Use Mist/MetaMask's provider
    window.web3 = new Web3(web3.currentProvider);
  } else {
    console.log('No web3? You should consider trying MetaMask!')
    // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
    window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
  }

  // Now you can start your app & access web3 freely:
  startApp()
var abi =[{"constant":true,"inputs":[],"name":"totalWeiWon","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"maxProfitAsPercentOfHouse","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newHouseEdge","type":"uint256"}],"name":"ownerSetHouseEdge","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"myid","type":"bytes32"},{"name":"result","type":"string"}],"name":"__callback","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"payoutsPaused","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newTreasury","type":"address"}],"name":"ownerSetTreasury","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"myid","type":"bytes32"},{"name":"result","type":"string"},{"name":"proof","type":"bytes"}],"name":"__callback","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"maxNumber","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"addressToCheck","type":"address"}],"name":"playerGetPendingTxByAddress","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newContractBalanceInWei","type":"uint256"}],"name":"ownerUpdateContractBalance","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"maxProfitDivisor","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newPayoutStatus","type":"bool"}],"name":"ownerPausePayouts","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"newOwner","type":"address"}],"name":"ownerChangeOwner","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"minNumber","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newMaxProfitAsPercent","type":"uint256"}],"name":"ownerSetMaxProfitAsPercentOfHouse","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"treasury","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalWeiWagered","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newMinimumBet","type":"uint256"}],"name":"ownerSetMinBet","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"newStatus","type":"bool"}],"name":"ownerPauseGame","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"gasForOraclize","outputs":[{"name":"","type":"uint32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"sendTo","type":"address"},{"name":"amount","type":"uint256"}],"name":"ownerTransferEther","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"contractBalance","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"minBet","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"playerWithdrawPendingTransactions","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"maxProfit","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalBets","outputs":[{"name":"","type":"int256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"gamePaused","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"originalPlayerBetId","type":"bytes32"},{"name":"sendTo","type":"address"},{"name":"originalPlayerProfit","type":"uint256"},{"name":"originalPlayerBetValue","type":"uint256"}],"name":"ownerRefundPlayer","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"newSafeGasToOraclize","type":"uint32"}],"name":"ownerSetOraclizeSafeGas","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[],"name":"ownerkill","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"houseEdge","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"rollUnder","type":"uint256"}],"name":"playerRollDice","outputs":[],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"houseEdgeDivisor","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"maxPendingPayouts","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"payable":true,"stateMutability":"payable","type":"fallback"},{"anonymous":false,"inputs":[{"indexed":true,"name":"BetID","type":"bytes32"},{"indexed":true,"name":"PlayerAddress","type":"address"},{"indexed":true,"name":"RewardValue","type":"uint256"},{"indexed":false,"name":"ProfitValue","type":"uint256"},{"indexed":false,"name":"BetValue","type":"uint256"},{"indexed":false,"name":"PlayerNumber","type":"uint256"}],"name":"LogBet","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"ResultSerialNumber","type":"uint256"},{"indexed":true,"name":"BetID","type":"bytes32"},{"indexed":true,"name":"PlayerAddress","type":"address"},{"indexed":false,"name":"PlayerNumber","type":"uint256"},{"indexed":false,"name":"DiceResult","type":"uint256"},{"indexed":false,"name":"Value","type":"uint256"},{"indexed":false,"name":"Status","type":"int256"},{"indexed":false,"name":"Proof","type":"bytes"}],"name":"LogResult","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"BetID","type":"bytes32"},{"indexed":true,"name":"PlayerAddress","type":"address"},{"indexed":true,"name":"RefundValue","type":"uint256"}],"name":"LogRefund","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"name":"SentToAddress","type":"address"},{"indexed":true,"name":"AmountTransferred","type":"uint256"}],"name":"LogOwnerTransfer","type":"event"}] 

var contract_address = '0xf562bb619da38135fffe965ca7f886a04a46f61a';
var c = web3.eth.contract(abi);
var contract = c.at(contract_address);
window.abi = abi;
window.contract_address = contract_address;
window.c = c;
window.contract = contract;

watchBalance();
})

function startApp(){

//var contract_address = '0x9e12b4c689e9995050dd224d43a40e98e3c733ec';
//var coinbase = web3.eth.coinbase;

}


function updateElement(name, content){
    document.getElementById(name).innerText =  content;
}

function watchBalance() {

updateElement('contract_address', contract_address);

contract.minBet(function(error, result){
    updateElement('min_bet', web3.fromWei(result.toString()));
});
<!--
contract.contractBalance(function(error, result){
    updateElement('total_bet', result.toString());
});

contract.houseEdge(function(error, result){
    updateElement('total_bet', web3.fromWei(result.toString()));
});

contract.maxPendingPayouts(function(error, result){
    updateElement('current_bet', web3.fromWei(result.toString()));
});

contract.totalWeiWon(function(error, result){
    updateElement('bet_status', result.toString());
});
-->

}

function sendBalance(){
    if (web3.eth.coinbase == null){
      alert("请先解锁 Metamask");
      return; 
    }
    var payload = {
        from: web3.eth.coinbase , 
        to: window.contract_address,
        value: web3.toWei(0.1, 'ether'),
        gas: 200000
    };
    console.log(payload)
    web3.eth.sendTransaction(payload , function(error, result){
        updateElement('sendTransaction', result.toString());
        }
    )
}

function openLottery() {
    var payload = {
        from: web3.eth.coinbase , 
        to: window.contract_address,
        gas: 200000};
    contract.openLottery(3,payload, function(error, result){
        updateElement('openLottery', result.toString());
        }
    );
}


function setMinBet() {
    var payload = {
        from: web3.eth.coinbase , 
        to: window.contract_address,
        gas: 200000};
    contract.ownerSetMinBet(web3.toWei(0.001, 'ether'),payload, function(error, result){
        updateElement('openLottery', result.toString());
        }
    );
}



function roll() {
    var payload = {
        from: web3.eth.coinbase ,
        to: window.contract_address,
        value: web3.toWei(0.01, 'ether'),
        gas: 500000};
    contract.playerRollDice(51,payload, function(error, result){
        updateElement('openLottery', result.toString());
        }
    );
}

function withdraw() {
    var payload = {from: web3.eth.coinbase , 
        to: window.contract_address,
        gas: 200000}
    contract.withdraw(payload, function(error, result){
        content = '撤回投注: ' + result.toString();
        updateElement('withdraw', content);
    });
}

</script>
</head>
<body>


  
    <div class="container">
  <div class="page-header">
    <h1>OTK Dice 骰子游戏  </h1>
<!--     <small>
      <div>账号</div>
      <div id="coinbase"></div>
      <div>余额</div>
      <div id="balance"></div>
    </small> -->
  </div>
    

<table class="table">
    <caption>OTK Dice 骰子游戏</caption>
   <thead>
      <tr>
         <th>名称</th>
         <th>信息</th>
      </tr>
   </thead>
   <tbody>
      <tr><td>投注金额</td> <td> 0.01 ETH</td> </tr>
      <tr><td>赢的机会</td> <td> 50</td> </tr>
      <tr>
        <td>操作</td>
        <td>    
          </div>
          <button type="button" class="btn btn-default" onClick="setMinBet();">
              <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>修改最小投注为0.001
          </button>

          <button type="button" class="btn btn-default" onClick="watchBalance();">
              <span class="glyphicon glyphicon-refresh" aria-hidden="true"></span>刷新信息
          </button>

          <button type="button" class="btn btn-success" onClick="roll();">
             <span class="glyphicon glyphicon-btc" aria-hidden="true"></span>
            开始投注</button>
          <div>
        </td>
        </div>
      <tr> <td>合约地址</td> <td><div id="contract_address"></div> </td> </tr>
      <tr> <td>合约余额</td> <td><div id="contract_balance"></div> </td> </tr>
      <tr> <td>最小投注额</td> <td><div id="min_bet"></div> </td> </tr>
      <tr> <td>投注交易哈希</td> <td><div id="sendTransaction"></div> </td> </tr>
      <tr> <td>开奖哈希</td> <td><div id="openLottery"></div> </td> </tr>
   </tbody>
</table>


    </div>
    <script src="http://cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
<script src="http://cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

</body>
</html>

