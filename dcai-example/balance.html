<!doctype>
<html>

<head>
<meta charset="UTF-8">
<script type="text/javascript" src="../node_modules/bignumber.js/bignumber.min.js"></script>
<script type="text/javascript" src="../dist/web3-light.js"></script>
<script type="text/javascript">

var Web3 = require('web3');
//var web3 = new Web3();

window.addEventListener('load', function() {

  // Checking if Web3 has been injected by the browser (Mist/MetaMask)
  if (typeof web3 !== 'undefined') {
    // Use Mist/MetaMask's provider
    window.web3 = new Web3(web3.currentProvider);
  } else {
    console.log('No web3? You should consider trying MetaMask!')
    // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
    window.web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
  }

  // Now you can start your app & access web3 freely:
  startApp()
var abi = [{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"platform_reward_percentage","inputs":[],"constant":true},{"type":"function","payable":true,"outputs":[],"name":"bet","inputs":[],"constant":false},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"max_betting_value","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"bytes32","name":""}],"name":"bettingIds","inputs":[{"type":"address","name":""},{"type":"uint256","name":""}],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"new_max_betting_percentage","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[],"name":"setMiniAndCount","inputs":[{"type":"uint256","name":"m_b"},{"type":"uint256","name":"b_c"}],"constant":false},{"type":"function","payable":false,"outputs":[],"name":"withdraw","inputs":[],"constant":false},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"new_platform_reward_percentage","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"new_bet_count","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[],"name":"close","inputs":[],"constant":false},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"minimal_bet","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"bool","name":""}],"name":"withdrawLottery","inputs":[],"constant":false},{"type":"function","payable":false,"outputs":[{"type":"uint8","name":""}],"name":"bet_status","inputs":[],"constant":true},{"type":"function","payable":true,"outputs":[],"name":"openLottery","inputs":[{"type":"uint256","name":"random_index"}],"constant":false},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"random_number","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"address","name":"key"},{"type":"uint256","name":"value"}],"name":"getBalancesKV","inputs":[{"type":"uint256","name":"index"}],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"current_bet","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"max_betting_percentage","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"total_bet","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[],"name":"acceptOwnership","inputs":[],"constant":false},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":"size"},{"type":"uint256","name":"num"}],"name":"balances","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"bet_count","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[],"name":"setBetCount","inputs":[{"type":"uint256","name":"b_c"}],"constant":false},{"type":"function","payable":false,"outputs":[{"type":"address","name":""}],"name":"owner","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"global_index","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"address","name":""}],"name":"oraclize_random_service","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[],"name":"changeOwner","inputs":[{"type":"address","name":"_newOwner"}],"constant":false},{"type":"function","payable":false,"outputs":[{"type":"bytes32","name":""}],"name":"lottery_id","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[],"name":"setLottery","inputs":[{"type":"uint256","name":"random_index"}],"constant":false},{"type":"function","payable":false,"outputs":[{"type":"address","name":""}],"name":"newOwner","inputs":[],"constant":true},{"type":"function","payable":false,"outputs":[],"name":"setMaxBettingPercent","inputs":[{"type":"uint256","name":"p"}],"constant":false},{"type":"function","payable":false,"outputs":[],"name":"setMinimalbet","inputs":[{"type":"uint256","name":"m_b"}],"constant":false},{"type":"function","payable":false,"outputs":[],"name":"setPlatformReward","inputs":[{"type":"uint256","name":"p"}],"constant":false},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"better_pending_lottery","inputs":[{"type":"address","name":""}],"constant":true},{"type":"function","payable":false,"outputs":[{"type":"uint256","name":""}],"name":"new_minimal_bet","inputs":[],"constant":true},{"type":"constructor","payable":false,"inputs":[{"type":"uint256","name":"mini"},{"type":"uint256","name":"b_c"},{"type":"uint256","name":"m_p"},{"type":"uint256","name":"p_r"},{"type":"address","name":"o_s"}]},{"type":"fallback","payable":true},{"type":"event","name":"Beted","inputs":[{"type":"address","name":"sender","indexed":true},{"type":"uint256","name":"value","indexed":true}],"anonymous":false},{"type":"event","name":"Withdraw","inputs":[{"type":"address","name":"sender","indexed":true},{"type":"uint256","name":"value","indexed":true}],"anonymous":false},{"type":"event","name":"LotteryHit","inputs":[{"type":"address","name":"lottery_reveiver","indexed":true},{"type":"bytes32","name":"id","indexed":true},{"type":"uint256","name":"lottery_value","indexed":true}],"anonymous":false},{"type":"event","name":"PlatformReward","inputs":[{"type":"address","name":"reward_receiver","indexed":true},{"type":"uint256","name":"reward_value","indexed":true}],"anonymous":false},{"type":"event","name":"OpenLottery","inputs":[{"type":"address","name":"opener","indexed":true},{"type":"uint256","name":"rand_num","indexed":true}],"anonymous":false},{"type":"event","name":"SendBettingId","inputs":[{"type":"address","name":"id_receiver","indexed":true},{"type":"bytes32","name":"id","indexed":true}],"anonymous":false},{"type":"event","name":"BetterPendingLottery","inputs":[{"type":"address","name":"lottery_pend_reveiver","indexed":true},{"type":"bytes32","name":"pend_id","indexed":true},{"type":"uint256","name":"lottery_pend_value","indexed":true}],"anonymous":false}]

var contract_address = '0x4f7d630814447f1b4c0719bb7a259c2bfd63f174';
var c = web3.eth.contract(abi);
var contract = c.at(contract_address);
window.abi = abi;
window.contract_address = contract_address;
window.c = c;
window.contract = contract;

watchBalance();
})

function startApp(){

//var contract_address = '0x9e12b4c689e9995050dd224d43a40e98e3c733ec';
//var coinbase = web3.eth.coinbase;

}


function watchBalance() {
contract.bet_count(function(error, result){
	if(!error){
	console.log('contract bet count');
	console.log(result.toString());
	document.getElementById('coinbase').innerText = '合约地址: ' + contract_address;
	document.getElementById('original').innerText = '最大投注数量: ' + result.toString();
	}
	else{
        console.error(error);
	}
});

contract.total_bet(function(error, result){
	if(!error){
	console.log(result.toString());
	document.getElementById('current').innerText = '总投注数量: ' + result.toString();
	}
	else{
        console.error(error);
	}
});

contract.minimal_bet(function(error, result){
document.getElementById('current').innerText +=  '\n 最小投注数量: ' + web3.fromWei(result.toString());
});

var current_bet;
contract.current_bet(function(error, result){
document.getElementById('current').innerText +=  '\n 当前已投注数量: ' + web3.fromWei(result.toString());
current_bet = result;
});

console.log('current_bet')
console.log(current_bet);

}

function sendBalance(){
    web3.eth.sendTransaction(
        {from: web3.eth.coinbase , 
        to: window.contract_address,
        value: web3.toWei(0.1, 'ether'),
        gas: 2000000}, function(error, result){
             
        document.getElementById('diff').innerText +=  '\n 投注交易哈希: ' + result.toString();
        }
    )
}


</script>
</head>
<body>
    <h1>OTK 合约信息 </h1>
    <button type="button" onClick="sendBalance();">开始投注</button>
    <button type="button" onClick="watchBalance();">刷新信息</button>
    <div></div>
    <div id="coinbase"></div>
    <div id="original"></div>
    <div id="current"></div>
    <div id="diff"></div>
</body>
</html>

